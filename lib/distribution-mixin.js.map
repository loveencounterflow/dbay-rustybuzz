{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/distribution-mixin.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'DRB/MIXIN/DISTRIBUTION'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\nguy                       = require 'guy'\nE                         = require './errors'\nSQL                       = String.raw\njr                        = JSON.stringify\njp                        = JSON.parse\n\n\n#-----------------------------------------------------------------------------------------------------------\n@Drb_distribution = ( clasz = Object ) => class extends clasz\n\n  # #---------------------------------------------------------------------------------------------------------\n  # constructor: ->\n  #   super()\n  #   guy.props.hide @, 'state', {} unless @state?\n  #   @state.prv_fontidx            = -1\n  #   @state.font_idx_by_fontnicks  = {}\n  #   #.........................................................................................................\n  #   return undefined\n\n  #-----------------------------------------------------------------------------------------------------------\n  distribute: ( cfg ) -> @_distribute_with_db cfg\n  # distribute: ( cfg ) -> @_distribute_v1 cfg\n\n  #-----------------------------------------------------------------------------------------------------------\n  _distribute_with_db: ( cfg ) ->\n    { ads     } = cfg\n    { schema,\n      prefix  } = @cfg\n    #.......................................................................................................\n    v =\n      mm_p_u:     cfg.mm_p_u\n      width_mm:   cfg.width_mm\n      width_u:    cfg.width_mm / cfg.mm_p_u # line width in glyf design unites (1000 per em)\n      size_mm:    cfg.size_mm               # nominal type size (1em)\n      size_u:     cfg.size_mm  / cfg.mm_p_u\n      adi0:       0                         # index of AD that represents current line start\n      dx0:        0                         # extraneous width (b/c paragraph was set in single long line)\n    #.......................................................................................................\n    create_udfs = ( v ) =>\n      @db.create_function name: prefix + 'get_deviation', deterministic: false, call: ( x1 ) =>\n        ### Essentiall distance of any point in the text from the end of the current line *relative to\n        type size and scaled such that 1em = 1000u. Most favorable break points are the ones closest to\n        zero. ###\n        return Math.round ( x1 - v.dx0 - v.width_u ) / v.size_u * 1000\n      return null\n    create_udfs v\n    #.......................................................................................................\n    @db =>\n      @db SQL\"\"\"\n        drop table if exists #{schema}.ads;\n        drop view if exists #{schema}.brps;\n        create table #{schema}.ads (\n            vnr     json not null primary key,\n            gid     integer,\n            b       integer,\n            x       integer not null,\n            y       integer not null,\n            dx      integer not null,\n            dy      integer not null,\n            x1      integer not null,\n            chrs    text,\n            sid     text,\n            br      text );\n        create view #{schema}.brps as\n          -- with\n          --   v1 as ( select max( adi ) as last_adi from #{schema}.ads ),\n          --   v2 as ( select x, dx, x1 from #{schema}.ads as ads join v1 on ( ads.adi = v1.last_adi ) )\n          select\n            *,\n            #{prefix}get_deviation( x1 ) as deviation\n          from #{schema}.ads\n          where br is not null;\"\"\"\n    @hollerith.alter_table { schema, table_name: 'ads', }\n    insert_into_ads = @db.prepare_insert { schema, into: 'ads', }\n    @db =>\n      insert_into_ads.run { br: null, ad..., vnr: ( jr [ ad.adi, ] ) } for ad in ads\n    console.table @db.all_rows SQL\"select vnr, gid, b, x, y, dx, dy, x1, chrs, sid, br from #{schema}.ads order by vnr_blob;\"\n    console.table @db.all_rows SQL\"select vnr, gid, b, x, y, dx, dy, x1, chrs, sid, br from #{schema}.brps order by vnr_blob;\"\n    console.table @db.all_rows SQL\"select vnr, gid, b, x, y, dx, dy, x1, chrs, sid, br from #{schema}.brps order by abs( deviation ) limit 5;\"\n    #.......................................................................................................\n    v.dx0         = 0\n    nxt_brp       = @db.single_row SQL\"select vnr, gid, b, x, y, dx, dy, x1, chrs, sid, br from #{schema}.brps where br = 'start' limit 1;\"\n    nxt_brp.vnr   = jp nxt_brp.vnr\n    prv_brp       = null\n    lines         = []\n    R             = { lines, }\n    loop\n      break if nxt_brp.br is 'end'\n      prv_brp       = nxt_brp\n      nxt_brp       = @db.single_row SQL\"select vnr, gid, b, x, y, dx, dy, x1, chrs, sid, br from #{schema}.brps order by abs( deviation ) limit 1;\"\n      nxt_brp.vnr   = jp nxt_brp.vnr\n      debug '^59686^', prv_brp.vnr, ( @hollerith.advance prv_brp.vnr ), nxt_brp.vnr\n      vnr_1         = @hollerith.advance prv_brp.vnr\n      vnr_2         = nxt_brp.vnr\n      vnr_1_blob    = @hollerith.encode vnr_1\n      vnr_2_blob    = @hollerith.encode vnr_2\n      text          = @db.single_value SQL\"select group_concat( chrs, '' ) as chrs from ads where vnr_blob between $vnr_1_blob and $vnr_2_blob;\", { vnr_1_blob, vnr_2_blob, }\n      text         += '-' if nxt_brp.br is 'shy'\n      info '^33209^', text\n      lines.push    { vnr_1, vnr_2, dx0: v.dx0, }\n      v.dx0         = nxt_brp.x\n    return R\n\n  #-----------------------------------------------------------------------------------------------------------\n  _distribute_v1: ( cfg ) ->\n    { ads\n      mm_p_u\n      width_mm  } = cfg\n    lines         = []\n    R             = { lines, }\n    width_u       = width_mm / mm_p_u # line width in glyf design unites (1000 per em)\n    brps          = []                # BReak PointS\n    #.......................................................................................................\n    ### Find BReak PointS: ###\n    brps.push { adi: 0, br: 'start', x: 0, }\n    for ad, adi in ads\n      continue unless ad.br?\n      brps.push { adi, br: ad.br, x: ad.x, }\n    last_adi  = ads.length - 1\n    last_ad   = ads[ last_adi ]\n    brps.push { adi: last_adi, br: 'end', x: last_ad.x + last_ad.dx, dx: 0, }\n    #.......................................................................................................\n    brpi      = -1                    # index to BRP\n    last_brpi = brps.length - 1\n    brpi1     = 0                     # index to left-hand BRP\n    brpi2     = null                  # index to right-hand BRP\n    adi1      = null                  # index to left-hand AD\n    adi2      = null                  # index to right-hand AD\n    dx0       = 0                     # extraneous width (b/c paragraph was set in single long line)\n    #.......................................................................................................\n    loop\n      brpi++\n      break if brpi > last_brpi\n      brp           = brps[ brpi ]\n      corrected_x   = brp.x - dx0\n      ### TAINT use tolerance to allow line break when line is just a bit too long ###\n      continue unless corrected_x > width_u\n      brpi2         = brpi - 1 ### TAINT may be < 0 when first word too long ###\n      adi1          = ( adi2 ? brps[ brpi1 ].adi - 1 ) + 1\n      adi2          = brps[ brpi2 ].adi\n      lines.push { adi1, adi2, dx0, }\n      brpi1         = brpi\n      dx0           = ads[ adi2 + 1 ].x\n    #.......................................................................................................\n    if adi2 < last_adi\n      dx0           = ads[ adi2 + 1 ].x\n      brpi1         = brpi2 + 1\n      brpi2         = last_brpi\n      adi1          = adi2 + 1\n      adi2          = last_adi\n      lines.push { adi1, adi2, dx0, }\n    #.......................................................................................................\n    lnr = 0\n    rnr = lines.length + 1\n    for line in lines\n      lnr++; line.lnr = lnr\n      rnr--; line.rnr = rnr\n      # continue unless ads[ line.adi2 ].br is 'shy'\n      ### TAINT consider to always use visible hyphen but hide it in CSS ###\n      ### TAINT not the way to do this ###\n      # ads[ line.adi2 ].sid = 'o14eg8i'\n      debug '^94509^', line\n    #.......................................................................................................\n    return R\n\n\n\n\n"
  ]
}