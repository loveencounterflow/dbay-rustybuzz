{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/arrangement-mixin.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'DRB/MIXIN/ARRANGEMENT'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\nguy                       = require 'guy'\nE                         = require './errors'\nSQL                       = String.raw\n{ width_of\n  to_width }              = require 'to-width'\njr                        = JSON.stringify\njp                        = JSON.parse\n\n\n#-----------------------------------------------------------------------------------------------------------\n@Drb_arrangement = ( clasz = Object ) => class extends clasz\n\n  # #---------------------------------------------------------------------------------------------------------\n  # constructor: ->\n  #   super()\n  #   return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  # _$arrangement_initialize: ->\n\n  #---------------------------------------------------------------------------------------------------------\n  ### 'arrange()' like 'compose()' and 'distribute()' ###\n  arrange: ( cfg ) ->\n    @types.validate.dbr_arrange_cfg ( cfg = { @constructor.C.defaults.dbr_arrange_cfg..., cfg..., } )\n    ads     = @_shape_text        { cfg..., trk: 1, }\n    shy_ads = @_shape_hyphenated  { cfg..., ads, }\n    return [ ads..., shy_ads..., ]\n\n  #---------------------------------------------------------------------------------------------------------\n  _shape_hyphenated: ( cfg ) ->\n    ### TAINT use proper validation ###\n    { fontnick\n      doc\n      par\n      ads         } = cfg\n    { schema      } = @cfg\n    { V, I, L,    } = @sql\n    left_ads        = []\n    right_ads       = []\n    #.......................................................................................................\n    { trk_max, } = @db.single_row SQL\"\"\"\n      select max( trk ) as trk_max\n      from #{schema}.ads where ( doc = $doc ) and ( par = $par );\"\"\", { doc, par, }\n    new_trk = trk_max\n    #.......................................................................................................\n    for { shy_b1, shy_sgi, } in @db.all_rows SQL\"\"\"\n      select b1 as shy_b1, sgi as shy_sgi from #{schema}.ads\n        where true\n          and ( doc = $doc )\n          and ( par = $par )\n          and ( br  in ( 'shy', 'wbr' ) )\n          and ( trk = 1 );\"\"\", { doc, par, }\n      #.....................................................................................................\n      # First batch: Characters in same shape group as SHY, up to the shy, with an added hyphen:\n      { text, b1, b2, dx0, } = @db.first_row SQL\"\"\"\n        select\n            coalesce(\n              group_concat( case when br = 'shy' then '' else chrs end, '' ),\n              '' ) || case when br = 'shy' then '-' else '' end               as text,\n            min( x )                                                          as dx0,\n            min( b1 )                                                         as b1,\n            max( b2 )                                                         as b2\n          from ads\n          where true\n            and ( doc = $doc )\n            and ( par = $par )\n            and ( sgi = $shy_sgi )\n            and ( b1 <= $shy_b1 )\n            and ( trk = 1 )\n          order by b1, id;\"\"\", { doc, par, shy_b1, shy_sgi, }\n      urge '^arg740-1^', { shy_b1, shy_sgi, dx0, text, new_trk, }\n      new_trk++\n      left_ads      = @_shape_text { cfg..., text, b1, b2, dx0, trk: new_trk, osgi: shy_sgi, }\n      urge '^arg740-2^', \"left_ads\"; console.table left_ads\n      # last_left_ad  = left_ads[ left_ads.length - 1 ]\n      #.....................................................................................................\n      { text, b1, b2, dx2, } = @db.first_row SQL\"\"\"\n        select\n            coalesce(\n              group_concat( case when br = 'shy' then '' else chrs end, '' ),\n              '' )                    as text,\n            max( x1 )                 as dx2,\n            min( b1 )                 as b1,\n            max( b2 )                 as b2\n          from ads\n          where true\n            and ( doc = $doc )\n            and ( par = $par )\n            and ( sgi = $shy_sgi )\n            and ( b1  > $shy_b1 )\n            and ( trk = 1 )\n          order by b1, id;\"\"\", { doc, par, shy_b1, shy_sgi, }\n      info '^arg740-3^', { text, dx2, }\n      if text isnt ''\n        urge '^arg740-4^', { shy_b1, shy_sgi, dx2, text, new_trk, }\n        right_ads = @_shape_text { cfg..., text, b1, b2, dx2, trk: new_trk, osgi: shy_sgi, }\n        urge '^arg740-5^', \"right_ads\"; console.table right_ads\n      urge '^arg740-6^'\n    #.......................................................................................................\n    return [ left_ads..., right_ads..., ]\n\n  #---------------------------------------------------------------------------------------------------------\n  _prepare_ads: ( text, fontnick, ads ) ->\n    ### As it stands `rustybuzz-wasm` will follow `rustybuzz` in that soft hyphens (SHYs) and word break\n    opportunities (WBRs) either get their own arrangement data item (AD) or else are tacked to the *front*\n    of one or more letters when they appear in the middle of a ligature (as in `af&shy;firm` with ligature\n    `ff` or `ffi`). In order to simplify processing and remove the case distinction, we normalize all cases\n    where WBRs and SHYs appear with other material to always make them standalone ADs. ###\n    R                 = []\n    { specials      } = @constructor.C\n    bytes             = Buffer.from text, { encoding: 'utf-8', }\n    prv_ad            = null\n    for ad, idx in ads\n      ad.b1     = ad.b\n      ad.b2     = ads[ idx + 1 ]?.b ? bytes.length\n      delete ad.b\n      ad.chrs   = bytes[ ad.b1 ... ad.b2 ].toString()\n      extra_ad  = null\n      has_shy   = false\n      has_wbr   = false\n      special   = null\n      if      ad.chrs.startsWith specials.shy.chrs then special = specials.shy\n      else if ad.chrs.startsWith specials.wbr.chrs then special = specials.wbr\n      ### SHY and WBR may appear together with other material in the same AD, this we don't want so we\n      separate those into their own ADs: ###\n      if special?\n        ad.br           = special.name\n        ad.gid          = special.gid\n        if ad.chrs.length > 1 ### NOTE safe b/c we know SHY is BMP codepoint ###\n          extra_ad      = { ad..., }\n          ad.b2         = ad.b1 + special.bytecount\n          extra_ad.chrs = ad.chrs[ 1 .. ]\n          extra_ad.b1   = ad.b2\n          extra_ad.br   = null\n          extra_ad.gid  = specials.ignored.gid\n          # extra_ad.sid  = @_get_sid { fontnick, gid: specials.ignored.gid, }\n          ad.chrs       = ad.chrs[ 0 ]\n          ad.dx         = 0\n          ad.x1         = ad.x\n      else if ad.chrs is ' '\n        ad.br           = specials.spc.name\n        ad.gid          = specials.spc.gid\n      else if ad.chrs is '-'\n        ad.br           = specials.hhy.name\n      else if ad.chrs is '\\n'\n        ad.br           = specials.nl.name\n        ad.gid          = specials.nl.gid\n      R.push ad\n      if extra_ad?\n        R.push extra_ad\n        extra_ad = null\n    prv_ad = ad\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  _shape_text: ( cfg ) ->\n    { fontnick\n      text\n      dx0   ### NOTE optional leftmost  x reference coordinate ###\n      dx2   ### NOTE optional rightmost x reference coordinate ###\n      b1    ### NOTE optional leftmost byte index ###\n      b2    ### NOTE optional rightmost byte index ###\n      doc\n      par\n      trk\n      osgi      }   = cfg\n    skip_ends       = dx0? or dx2? ### TAINT will probably be removed ###\n    b1             ?= 0\n    b2             ?= null\n    dx0            ?= 0 ### TAINT use validation, defaults ###\n    dx2            ?= null\n    font_idx        = @_font_idx_from_fontnick fontnick\n    ads             = JSON.parse @RBW.shape_text { format: 'json', text, font_idx, }\n    ads             = @_prepare_ads text, fontnick, ads\n    { specials\n      fontmetrics } = @constructor.C\n    { missing   }   = specials\n    { schema    }   = @cfg\n    #.......................................................................................................\n    ced_x           = 0 # cumulative error displacement from missing outlines\n    ced_y           = 0 # cumulative error displacement from missing outlines\n    osgi           ?= null\n    sgi             = 0\n    ### TAINT will not properly handle multiple SHYs in the same segment (this might happen in ligatures\n    like `ffi`) ###\n    for ad, idx in ads\n      sgi++ unless ad.nobr\n      ad.doc      = doc\n      ad.par      = par\n      ad.trk      = trk\n      ad.b1      += b1\n      ad.b2      += b1\n      ad.sgi      = sgi\n      ad.osgi     = osgi\n      ad.fontnick = fontnick\n      ad.x       += ced_x\n      ad.y       += ced_y\n      #.....................................................................................................\n      # Replace original metrics with those of missing outline:\n      if ad.gid is specials.missing.gid\n        if ( width_of ( Array.from ad.chrs )[ 0 ] ) < 2\n          width   = specials.missing1.width\n          ad.gid  = specials.missing1.gid\n        else\n          width   = specials.missing2.width\n          ad.gid  = specials.missing2.gid\n        ed_x    = width - ad.dx\n        ced_x  += ed_x\n        ad.dx   = width\n      #.....................................................................................................\n      ad.x    = Math.round ad.x + dx0\n      ad.y    = Math.round ad.y\n      ad.dx   = Math.round ad.dx\n      ad.dy   = Math.round ad.dy\n      ad.x1   = ad.x + ad.dx\n      # debug '^arg740-7^', ( rpr ad.chrs ), to_width ( rpr ad ), 100\n    #.......................................................................................................\n    if b2?  then  ads[ ads.length - 1 ].b2 = b2\n    if dx2? then  delta_x = dx2 - ads[ ads.length - 1 ].x1\n    else          delta_x = 0\n    #.......................................................................................................\n    @db =>\n      insert_ad = @db.prepare @sql.insert_ad\n      last_idx  = ads.length - 1\n      for ad, idx in ads\n        ad.x       += delta_x\n        ad.x1      += delta_x\n        ad.br       = 'end' if ( trk is 1 ) and ( idx is last_idx )\n        row         = { br: null, ad..., }\n        row.nobr    = if row.nobr then 1 else 0\n        # debug '^arg740-8^', row\n        ads[ idx ]  = @db.first_row insert_ad, row\n      return null\n    #.......................................................................................................\n    return ads\n"
  ]
}